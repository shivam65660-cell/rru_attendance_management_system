{% extends "base.html" %}
{% block content %}
<div class="container mt-5">

  <!-- ğŸ”· Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">
      ğŸ“ Student Attendance Dashboard
    </h2>
    <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
      ğŸ”‘ Change Password
    </button>
  </div>

  <!-- ğŸ”¹ Attendance Summary Table -->
  <div class="card shadow-sm mb-5">
    <div class="card-header bg-primary text-white fw-semibold">
      ğŸ“Š Subject & Semester-wise Attendance Summary
    </div>
    <div class="card-body p-0">
      {% if summary %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle mb-0">
          <thead class="table-primary text-center">
            <tr>
              <th>Semester</th>
              <th>Subject</th>
              <th>Total Classes</th>
              <th>Present</th>
              <th>Attendance %</th>
            </tr>
          </thead>
          <tbody>
            {% for row in summary %}
            <tr class="text-center">
              <td>{{ row['semester'] }}</td>
              <td>{{ row['subject_name'] }}</td>
              <td>{{ row['total_classes'] }}</td>
              <td>{{ row['present_count'] }}</td>
              <td>
                {% if row['percentage'] >= 75 %}
                  <span class="badge bg-success">{{ row['percentage'] }}%</span>
                {% elif row['percentage'] >= 50 %}
                  <span class="badge bg-warning text-dark">{{ row['percentage'] }}%</span>
                {% else %}
                  <span class="badge bg-danger">{{ row['percentage'] }}%</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-center text-muted my-3">No attendance summary available.</p>
      {% endif %}
    </div>
  </div>

  <!-- ğŸ”¹ Detailed Attendance Table -->
  <div class="card shadow-sm mb-5">
    <div class="card-header bg-dark text-white fw-semibold">
      ğŸ“… Detailed Attendance Records
    </div>
    <div class="card-body p-0">
      {% if attendance %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle mb-0">
          <thead class="table-dark text-center">
            <tr>
              <th>Date</th>
              <th>Roll No.</th>
              <th>Semester</th>
              <th>Subject</th>
              <th>Teacher</th>
              <th>Status</th>
              <th>Remark</th>
            </tr>
          </thead>
          <tbody>
            {% for row in attendance %}
            <tr class="text-center">
              <td>{{ row['date'] }}</td>
              <td>{{ row['roll_number'] }}</td>
              <td>{{ row['semester'] }}</td>
              <td>{{ row['subject_name'] }}</td>
              <td>{{ row['teacher_name'] }}</td>
              <td>
                {% if row['status'] == 'Present' %}
                  <span class="badge bg-success">Present</span>
                {% elif row['status'] == 'Absent' %}
                  <span class="badge bg-danger">Absent</span>
                {% else %}
                  <span class="badge bg-secondary">{{ row['status'] }}</span>
                {% endif %}
              </td>
              <td>{{ row['remark'] or "-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-center text-muted my-3">No attendance records found.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- ğŸ“¨ Notifications Section -->
  <div class="container mt-4">
    <h3 class="mb-3">ğŸ“¢ Notifications</h3>
    {% if notifications %}
      {% for n in notifications %}
        <div class="card mb-3 shadow-sm">
          <div class="card-header bg-light">
            <strong>{{ n.title }}</strong>
            <span class="text-muted float-end small">{{ n.created_at }}</span>
          </div>
          <div class="card-body">
            <p>{{ n.message|replace('\n', '<br>')|safe }}</p>
            <p class="small text-muted">From: {{ n.teacher_name }}</p>
            {% if n.file_path %}
              <a href="{{ url_for('uploaded_notification', filename=n.file_path.split('/')[-1]) }}"
                 class="btn btn-sm btn-outline-primary">
                 ğŸ“ Download {{ n.file_name }}
              </a>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">No notifications.</p>
    {% endif %}
  </div>

<!-- ğŸ” Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="changePasswordModalLabel">ğŸ”‘ Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{{ url_for('change_password') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="old_password" class="form-label">Old Password</label>
            <input type="password" class="form-control" id="old_password" name="old_password" required>
          </div>
          <div class="mb-3">
            <label for="new_password" class="form-label">New Password</label>
            <input type="password" class="form-control" id="new_password" name="new_password" required>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- âœ… Bootstrap JS -->


<!-- ğŸ‘ Show/Hide Password Script -->
<script>
document.querySelectorAll('input[type="password"]').forEach(input => {
  input.insertAdjacentHTML('afterend', '<small class="text-muted ms-2" style="cursor:pointer;" onclick="togglePassword(this)">ğŸ‘ Show</small>');
});

function togglePassword(el) {
  const input = el.previousElementSibling;
  if (input.type === "password") {
    input.type = "text";
    el.textContent = "ğŸ™ˆ Hide";
  } else {
    input.type = "password";
    el.textContent = "ğŸ‘ Show";
  }
}
</script>
{% endblock %}
