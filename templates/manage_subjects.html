{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-primary">Manage Subjects</h2>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Add Subject Form -->
  <form method="POST" action="{{ url_for('manage_subjects') }}" class="row g-3 mb-4 needs-validation" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="col-md-3">
      <label class="form-label">Select School</label>
      <select name="school_id" id="school" class="form-select" required>
        <option value="">Choose...</option>
        {% for s in schools %}
        <option value="{{ s.id }}">{{ s.school_name }}</option>
        {% endfor %}
      </select>
      <div class="invalid-feedback">Please select a school.</div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Select Course</label>
      <select name="course_id" id="course" class="form-select" required>
        <option value="">Choose...</option>
      </select>
      <div class="invalid-feedback">Please select a course.</div>
    </div>

    <div class="col-md-2">
      <label class="form-label">Semester</label>
      <select name="semester" id="semester" class="form-select" required>
        <option value="">Choose...</option>
        {% for i in range(1, 11) %}
        <option value="{{ i }}">Semester {{ i }}</option>
        {% endfor %}
      </select>
      <div class="invalid-feedback">Please select a semester.</div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Subject Name</label>
      <input type="text" name="subject_name" class="form-control" placeholder="Enter Subject Name" required>
      <div class="invalid-feedback">Please enter a subject name.</div>
    </div>

    <div class="col-md-1 d-grid align-items-end">
      <button class="btn btn-success mt-2">Add</button>
    </div>
  </form>

  <!-- Subjects Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark text-center">
        <tr>
          <th>#</th>
          <th>Subject Name</th>
          <th>Course</th>
          <th>School</th>
          <th>Semester</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody class="text-center">
        {% for s in subjects %}
        <tr>
          <td>{{ loop.index }}</td> 
          <td>{{ s.subject_name }}</td>
          <td>{{ s.course_name }}</td>
          <td>{{ s.school_name }}</td>
          <td>{{ s.semester }}</td>
          <td>
            <a href="{{ url_for('delete_subject', id=s.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Delete this subject?')">
              Delete
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-muted">No subjects added yet</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- JS for dynamic course loading -->
<script>
document.getElementById('school').addEventListener('change', function() {
  const schoolId = this.value;
  const courseSelect = document.getElementById('course');
  courseSelect.innerHTML = '<option value="">Loading...</option>';

  if (schoolId) {
    fetch('/get_courses/' + schoolId)
      .then(response => response.json())
      .then(data => {
        courseSelect.innerHTML = '<option value="">Choose...</option>';
        data.forEach(course => {
          const option = document.createElement('option');
          option.value = course.id;
          option.textContent = course.course_name;
          courseSelect.appendChild(option);
        });
      });
  } else {
    courseSelect.innerHTML = '<option value="">Choose...</option>';
  }
});

// Bootstrap validation
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>
{% endblock %}
